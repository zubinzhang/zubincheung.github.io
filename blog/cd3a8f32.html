<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>redis的过期策略和内存淘汰 | Zubin | Later Equals Never</title>

  
  <meta name="author" content="Zubin">
  

  
  <meta name="description" content="之前经常将将 Redis 的过期策略和内存淘汰策略搞混淆，查阅了一些资料后做个总结。">
  

  
  
  <meta name="keywords" content="Redis">
  

  <meta id="viewport" name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">

  <meta property="og:title" content="redis的过期策略和内存淘汰"/>

  <meta property="og:site_name" content="Zubin"/>

  
  <meta property="og:image" content="/favicon.ico"/>
  

  <link href="/favicon.ico" rel="icon">
  <link rel="alternate" href="/atom.xml" title="Zubin" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
<meta name="generator" content="Hexo 5.4.2"></head>


<body>
<div class="blog">
  <div class="content">

    <header>
  <div class="site-branding">
    <h1 class="site-title">
      <a href="/">Zubin</a>
    </h1>
    <p class="site-description">Later Equals Never</p>
  </div>
  <nav class="site-navigation">
    <ul>
      
    </ul>
  </nav>
</header>

    <main class="site-main posts-loop">
    <article>

  
    
    <h3 class="article-title"><span>redis的过期策略和内存淘汰</span></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/blog/cd3a8f32.html" rel="bookmark">
        <time class="entry-date published" datetime="2020-05-17T03:10:08.000Z">
          2020-05-17
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <p>之前经常将将 Redis 的过期策略和内存淘汰策略搞混淆，查阅了一些资料后做个总结。</p>
<span id="more"></span>

<h2 id="过期策略"><a href="#过期策略" class="headerlink" title="过期策略"></a>过期策略</h2><p>Redis 所有的 key 都可以设置过期时间，时间一到就回自动删除。</p>
<h3 id="如何设置过期时间"><a href="#如何设置过期时间" class="headerlink" title="如何设置过期时间"></a>如何设置过期时间</h3><p>常用的方式有：</p>
<ul>
<li>EXPIRE key seconds</li>
<li>EXPIREAT key timestamp</li>
</ul>
<p>字符串独有的方式：</p>
<ul>
<li>SET key value [expiration EX seconds|PX milliseconds][nx|xx]</li>
<li>SETEX key seconds value</li>
</ul>
<h3 id="Redis-采用的过期策略"><a href="#Redis-采用的过期策略" class="headerlink" title="Redis 采用的过期策略"></a>Redis 采用的过期策略</h3><ul>
<li><p>惰性删除</p>
<ul>
<li>在进行 get 或 setnx 等操作时，先检查 key 是否过期，</li>
<li>若过期，删除 key，然后执行相应操作；</li>
<li>若没过期，直接执行相应操作</li>
</ul>
</li>
<li><p>定期删除<br>依次遍历每个数据库，默认每秒进行十次过期扫描</p>
<ol>
<li>检查当前库中的随机 20 个 key</li>
<li>删除这 20 个 key 中已经过期的 key；</li>
<li>如果过期的 key 比率超过 1&#x2F;4，那就重复步骤 1</li>
</ol>
<p>为了保证过期扫描不会出现循环过度，导致线程卡死现象,会判断定期删除操作是否已经达到指定时长（默认不会超过 25ms），若已经达到，直接退出定期删除。</p>
</li>
</ul>
<p>如果某一个时间段，缓存集中过期失效，对于数据库而言，就会产生周期性的压力波峰造成<em>缓存雪崩</em>。如果有大批量的 key 过期，要给过期时间设置一个随机范围，而不宜全部在同一时间过期，分散过期处理的压力。</p>
<h2 id="内存淘汰机制"><a href="#内存淘汰机制" class="headerlink" title="内存淘汰机制"></a>内存淘汰机制</h2><p>用于缓存的内存不足时，Redis 提供了几种可选策略 (maxmemory-policy) 来让用户自己决定该如何腾出新的空间以继续提供读写服务。</p>
<ul>
<li><p><strong>noeviction</strong> 不会继续服务写请求 (DEL 请求可以继续服务)，读请求可以继续进行。这样可以保证不会丢失数据，但是会让线上的业务不能持续进行。这是默认的淘汰策略。</p>
</li>
<li><p><strong>volatile-lru</strong> 尝试淘汰设置了过期时间的 key，最少使用的 key 优先被淘汰。没有设置过期时间的 key 不会被淘汰，这样可以保证需要持久化的数据不会突然丢失。</p>
</li>
<li><p><strong>volatile-ttl</strong> 跟上面一样，除了淘汰的策略不是 LRU，而是 key 的剩余寿命 ttl 的值，ttl 越小越优先被淘汰。</p>
</li>
<li><p><strong>volatile-random</strong> 跟上面一样，不过淘汰的 key 是过期 key 集合中随机的 key。</p>
</li>
<li><p><strong>allkeys-lru</strong> 区别于 volatile-lru，这个策略要淘汰的 key 对象是全体的 key 集合，而不只是过期的 key 集合。这意味着没有设置过期时间的 key 也会被淘汰。</p>
</li>
<li><p><strong>allkeys-random</strong> 跟上面一样，不过淘汰的策略是随机的 key。</p>
</li>
</ul>
<p>如果你只是拿 Redis 做缓存，那应该使用 allkeys-xxx，客户端写缓存时不必携带过期时间。<br>如果你还想同时使用 Redis 的持久化功能，那就使用 volatile-xxx 策略，这样可以保留没有设置过期时间的 key，它们是永久的 key 不会被 LRU 算法淘汰。</p>
<h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p>Redis 采用<em>惰性删除</em>和<em>定期删除</em>，处理过期的缓存数据。<br>Redis 的<em>内存淘汰策略</em>的选取并不会影响过期的 key 的处理，用于处理内存不足时的需要申请额外空间的数据。</p>
<h2 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h2><p><a target="_blank" rel="noopener" href="https://redis.io/commands/expire">Expires</a><br><a target="_blank" rel="noopener" href="https://redis.io/topics/lru-cache">Redis as an LRU cache</a></p>

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    
      

    <span class="post-categories">
      <i class="icon-categories"></i>
        <a href="/categories/数据库/">数据库</a>
    </span>
    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/Redis/">Redis</a>
    </span>
    

    </div>

    
  </div>
</article>

  






    </main>

    <footer class="site-footer">
  <p class="site-info">
    Proudly powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and
    Theme by <a href="https://github.com/CodeDaraW/Hacker" target="_blank">Hacker</a>
    </br>
    
    &copy; 2022 Zubin
    
  </p>
</footer>
    
    
  </div>
</div>
</body>
</html>